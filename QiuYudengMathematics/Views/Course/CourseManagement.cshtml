@model Dictionary<int, string>

    @*<input type="button" value="Query" onclick="Query()" />
    <input type="button" value="SingleQuery" onclick="SingleQuery()" />
    <input type="button" value="Insert" onclick="Insert()" />
    <input type="button" value="Update" onclick="Update()" />*@
    <div id="app" class="course-management">
        <div class="course-management__container">
            <div class="course-management__search-bar--flex">
                <input @@input="onInput($event)" placeholder="請輸入課程名稱" type="search">
                <div class="course-management__btn-wrapper">
                    <a @@click="addCourse" class="blue-btn">新增</a>
                </div>
            </div>
            <div class="course-management__table">
                <div class="course-management__tr">
                    <div class="course-management__th">課程</div>
                    <div class="course-management__th">名稱</div>
                    <div class="course-management__th">年級</div>
                    <div class="course-management__th">科目</div>
                    <div class="course-management__th">狀態</div>
                    <div class="course-management__th">管理</div>
                </div>
                <div class="course-management__tr" v-for="item in eachPageList" :key="item.CourseSeq">
                    <div class="course-management__td">
                        <img class="course-thumbnail" style="width:70px;height:40px;" :src="'http://img.youtube.com/vi/'+parseYoutubeId(item.Url)+'/sddefault.jpg'"/>
                    </div>
                    <div class="course-management__td">{{item.CourseName}}</div>
                    <div class="course-management__td">{{item.SubbjectInfo.SubjectGradeName}}</div>
                    <div class="course-management__td">{{item.SubbjectInfo.SubjectName}}</div>
                    <div class="course-management__td">
                        <i v-if="item.Enable" style="color:forestgreen" class="far fa-circle"></i>
                        <i v-else style="color:red" class="fas fa-times"></i>
                    </div>
                    <div class="course-management__td"><a @@click.prevent="showPopUp(item.CourseSeq)"><i class="fas fa-cog"></i></a></div>
                </div>
            </div>
            <div v-show="curList.length > 10" class="pagenation">
                <a @@click.prevent="setPage(1)">First</a>
                <a @@click.prevent="setPage(previousPage)">Previous</a>
                <a v-for="(n, index) in totalPageCount" v-show="pageRule(n)" v-bind:class=" currPage === n ? 'active' : '' " :key="n"
                   @@click.prevent="setPage(n)">{{n}}</a>
                <a @@click.prevent="setPage(nextPage)">Next</a>
                <a @@click.prevent="setPage(totalPageCount)">Last</a>
            </div>
        </div>
        <div v-show="pupUpOn" class="popup--wrapper">
            <div class="popup">
                <div class="popup--heading">
                    <span>課程管理</span>
                    <i @@click="hidePopUp" class="fas fa-times"></i>
                </div>
                <div class="popup--body">
                    <div>
                        <p>名稱</p>
                        <input class="width200" :value="info.Name" v-model="info.CourseName" />
                    </div>
                    <div>
                        <p>連結</p>
                        <input class="width200" :value="info.Name" v-model="info.Url" />
                    </div>
                    <div>
                        <p>年級</p>
                        <div class="width200">
                            <input type="radio" id="one" value="1" v-model="info.Grade">
                            <label for="one">高一</label>
                            <input type="radio" id="two" value="2" v-model="info.Grade">
                            <label for="two">高二</label>
                            <input type="radio" id="three" value="3" v-model="info.Grade">
                            <label for="three">高三</label>
                        </div>
                    </div>
                    <div>
                        <p>狀態</p>
                        <div class="width200">
                            <input type="checkbox" id="checkbox" v-model="info.Enable">
                            <label for="checkbox">{{ info.Enable?"啟用":"停用" }}</label>
                        </div>
                    </div>
                    <div>
                        <p>科目</p>
                        <div class="width200">
                            <div v-for="item in currentSubectList" class="subject-item">
                                <input type="radio" :id="item.ID" :value="String(item.ID)" v-model="info.SubjectId">
                                <label :for="item.ID">{{item.SubjectName}}</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="popup--footer">
                    <a @@click="submit" class="blue-btn">儲存</a>
                </div>
            </div>
    </div>
</div>

    <script type="text/javascript">
    const vm = new Vue({
        el: '#app',
        data: {
            rawList:[],
            curList:[],
            pupUpOn: false,
            allSubjectList:[],
            subject: '',
            info: {
                CourseSeq:0,
                CourseName: '',
                Url: '',
                SubjectId: '',
                Grade:'',
                Enable: true,
                Student: []
            },
            currPage: 1,
            itemPerPage: 10
        },
        mounted() {
             //取得所有影片，帶科目(查詢所有就放Null)
            const val = null;
            axios.post('@(Url.Content("~/Course/Query?SubjectId="))' + `${val}`)
                .then(res => {
                    this.rawList = res.data.Data
                    this.curList = this.rawList
                });
            //取得所有科目表
            axios.post('@Url.Content("~/Account/GetGradeSubject")')
                .then(res => {
                    this.allSubjectList = res.data.Data
                });

        },
        computed: {
            groupSubjectByGrade() {
                return this.allSubjectList.find(item => String(item.GradeId) === String(this.info.Grade))
            },
            currentSubectList() {
                return this.groupSubjectByGrade ? this.groupSubjectByGrade.Subject : [];
            },
            previousPage() {
                return this.currPage - 1 > 0 ? this.currPage - 1 : 1;
            },
            nextPage() {
                return this.currPage + 1 > this.totalPageCount ? this.totalPageCount : this.currPage + 1;
            },
            totalPageCount() {
                return Math.ceil(this.curList.length / this.itemPerPage);
            },
            eachPageList() {
                const lastIdx = this.currPage * this.itemPerPage;
                const firstIdx = lastIdx - this.itemPerPage;

                return this.curList.slice(firstIdx, lastIdx);
            },
            //sortedCurList() {
            //    return this.GradeSoringRule === 0 ? this.curList : this.GradeSoringRule === 1 ?
            //        this.curList.sort((a, b) => a.Grade - b.Grade) : this.curList.sort((a, b) => b.Grade - a.Grade)
            //}
        },
        methods: {
            mapSubjectAndGrade(id) {
            },
            parseYoutubeId(url) {
                const parsingUrl = new URL(url);
                return parsingUrl.searchParams.get('v')
            },
            onInput(e) {
                this.currPage = 1;
                this.curList = this.rawList.filter(item =>
                    item.CourseName.toLowerCase().indexOf(e.target.value.toLowerCase()) >= 0)
            },
            showPopUp(val) {
                axios.post('@Url.Content("~/Course/SingleQuery?Seq=")' + `${val}`)
                    .then(res => {
                        console.log(res.data.Data)
                        this.info.CourseSeq = res.data.Data.CourseSeq
                        this.info.CourseName = res.data.Data.CourseName
                        this.info.Url = res.data.Data.Url
                        this.info.Grade = String(res.data.Data.SubbjectInfo.SubjectGradeId)
                        this.info.Enable = res.data.Data.Enable
                        this.info.SubjectId = String(res.data.Data.SubbjectInfo.SubjectId)
                        this.info.Student = res.data.Data.Student   
                    }).finally(() => { this.pupUpOn = true; })
            },
            hidePopUp() {
                this.pupUpOn = false;
            },
            addCourse() {
                this.info = {
                    CourseSeq: 0,
                    CourseName: '',
                    Url: '',
                    SubjectId: '',
                    Grade: '1',
                    Enable: true,
                    Student: []
                }
                this.pupUpOn = true;
            },
            submit() {
                let data = {
                    CourseName: this.info.CourseName,
                    SubjectId: parseInt(this.info.SubjectId),
                    Enable: this.info.Enable,
                    Url: this.info.Url,
                    Student: null
                }
                if (this.info.CourseSeq === 0) {
                    //新增影片資料
                    console.log(data)
                    axios.post('@Url.Content("~/Course/Insert")', data)
                        .then(res => {
                            alert(res.data.Msg)
                            if (res.data.Success) {
                                location.reload();
                            };
                        });
                } else {
                    data.CourseSeq = this.info.CourseSeq
                     //修改影片資料
                    console.log(data)
                    axios.post('@Url.Content("~/Course/Update")', data)
                        .then(res => {
                            alert(res.data.Msg)
                            if (res.data.Success) {
                                location.reload();
                            };
                        });
                }
            },
            setPage(n) {
                this.currPage = n
            },
            pageRule(page) {
                return this.currPage == 1 || this.currPage == this.totalPageCount ?
                    Math.abs(this.currPage - page) <= 2 : Math.abs(this.currPage - page) <= 1;
            },
            //sortByGrade(foo) {
            //    //calculate SortingCal 0 => default which is not working, 1 =>acs, -1 => des
            //    this.GradeSoringRule = this.sortRule % 2 === 0 ? 0 : foo
            //}
        }
    });
    </script>

@*<script type="text/javascript">
    function Query() {
        var aa = null; //這是條件，帶科目(查詢所有就放Null)
        $.post("@(Url.Content("~/Course/Query?SubjectId="))" + aa, function (x) {
            alert(x.Data[0].CourseName);
        });
    };

    function SingleQuery() {
        //查單一影片，放影片Seq
        $.post("@(Url.Content("~/Course/SingleQuery?Seq="))" + 1, function (x) {
            alert(x.Data.CourseName);
        });
    };

    function Insert() {
        var data = {
            CourseName: 'Test2',
            Url: 'https://www.youtube.com/embed/HUZki1tTB0A', //後端會檢查格式，前端檢查是否必填
            SubjectId: 2,
            Enable: false,
            Student: ['000003'] //影片個別放沒有購買課程的學生,沒設定就放Null
        };
        $.post("@(Url.Content("~/Course/Insert"))", data, function (x) {
            alert(x.Msg);
        });
    };

    function Update() {
        var data = {
            CourseSeq: 1,
            CourseName: 'TestTwo',
            Url: 'https://www.youtube.com/embed/1v1CiLQXho8?list=RD1v1CiLQXho8', //後端會檢查格式，前端檢查是否必填
            SubjectId: 2,
            Enable: true,
            Student: null //影片個別放沒有購買課程的學生,沒設定就放Null
        };
        $.post("@(Url.Content("~/Course/Update"))", data, function (x) {
            alert(x.Msg);
        });
    };
</script>*@